<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
	<style> 
	    html, body, #map { height: 100%; padding: 0; margin: 0;}
	  </style>
</head>
<body>
	<!-- <canvas id = "the_canvas" width = "700" height = "600"></canvas> -->
	<div id="map"></div>

</body>
<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="leaflet_canvas_layer.js"></script>
<script type="text/javascript">

	var map = L.map('map').setView([0.0, -40.0], 2);

    L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery <a href="http://stamen.com">Stamen</a>'
    }).addTo(map);

	var Line = function(geometry){
		this.points = geometry;
		this.frequency = 5000; // ms to cross the line 
		// Travelers are the points "traveling" along a path.
		this.travelers = 40;
		this.getLineProperties();
		this.startTime = Date.now();
		this.projEndTime = this.startTime + this.frequency;
	} 

	var Utils = {
		mapRange: function(value, low1, high1, low2, high2) {
		    return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
		}
	};

	Line.prototype = {
		
		getLineProperties: function(){
			var sum = 0;
			for (var i = 0; i < this.points.length; i++){
				if (i == this.points.length - 1) continue;
				var width = Math.abs(this.points[i].x - this.points[i].y);
				var height = Math.abs(this.points[i + 1].x - this.points[i + 1].y);
				sum += Math.sqrt(Math.pow(width, 2) + Math.pow(height, 2));
				this.points[i].milestone = sum;
			}
			this.lineLength = sum;	
			for (var i = 0; i < this.points.length; i++){
				if (i == this.points.length - 1) continue;
				this.points[i].milestone = Utils.mapRange(this.points[i].milestone, 0, this.lineLength, 0, 1);
			}
		},
		getTravelerPositions: function(stamp){
			stamp = this.startTime + stamp % this.frequency;
			var proportion = Utils.mapRange(stamp, this.startTime, this.projEndTime, 0, 1);
			var travelerPositions = [];
			for (var p = 0; p<this.travelers; p++){
				proportion = (proportion + (1/this.travelers)*p)%1;
				for (var i = 0; i < this.points.length; i++){
					if (proportion <= this.points[i].milestone){
						var startProportion = this.points[i - 1]? this.points[i - 1].milestone: 0;
						var x = Utils.mapRange(proportion, startProportion, this.points[i].milestone, this.points[i].x, this.points[i+1].x);
						var y = Utils.mapRange(proportion, startProportion, this.points[i].milestone, this.points[i].y, this.points[i+1].y);
						travelerPositions.push({x: x, y: y});
						break;
					}	
				}
			}
			return travelerPositions;
		}
	}

	var Animator = function(canvas, options){
		this.lines = [];
		this.canvas = canvas;
		this.context = this.canvas.getContext("2d");
		this.linesDrawn = true;
	}

	Animator.prototype = {
		play: function(){
			this.tick();
		},
		tick: function(){
			for (var i = 0; i<this.lines.length; i++){
				var line = this.lines[i];
				this.context.clearRect ( 0 , 0 , this.canvas.width, this.canvas.height );
				var positions = line.getTravelerPositions(Date.now());
				for(var i = 0; i<positions.length; i++){
					this.drawTraveler(positions[i]);
				}
				this.linesDrawn && this.drawLines();
				
			}
			window.requestAnimationFrame(this.tick.bind(this));
		},
		drawTraveler: function(traveler){
			this.context.beginPath();
		    this.context.arc(traveler.x, traveler.y, 2, 0, 2 * Math.PI, false);
		    this.context.fillStyle = "darkblue";
		    this.context.fill();
		},
		addLine: function(line){
			this.lines.push(line);
		},
		drawLines: function(){
			var self = this;
			this.lines.forEach(function(line){
				var points = line.points;
				self.context.beginPath();
				self.context.moveTo(points[0].x, points[0].y);
				for(var i = 1; i<points.length; i++){
					self.context.lineTo(points[i].x, points[i].y);
				}
				self.context.stroke();
			});
			
		},
	}

	function FluxLayer(){
		this.geometry = ['{',
		'rows: [',
		'{',
		'cartodb_id: 1,',
		'proportion: 20,',
		'the_geom: "{"type":"MultiLineString","coordinates":[[[-8.4375,42.94033923],[-77.16796875,37.99616268]]]}"',
		'},',
		'{',
		'cartodb_id: 2,',
		'proportion: 2,',
		'the_geom: "{"type":"MultiLineString","coordinates":[[[-7.734375,42.55308029],[-0.87890625,51.72702816]]]}"',
		'},',
		'{',
		'cartodb_id: 3,',
		'proportion: 40,',
		'the_geom: "{"type":"MultiLineString","coordinates":[[[-8.26171875,43.58039086],[-65.21484375,-39.90973623]]]}"',
		'},',
		'{',
		'cartodb_id: 4,',
		'proportion: 5,',
		'the_geom: "{"type":"MultiLineString","coordinates":[[[-8.4375,42.94033923],[-75.5859375,4.39022893]]]}"',
		'},',
		'{',
		'cartodb_id: 5,',
		'proportion: 50,',
		'the_geom: "{"type":"MultiLineString","coordinates":[[[-8.4375,43.06888777],[2.63671875,48.10743119]]]}"',
		'}',
		']',
		'} '].join();
	}

	FluxLayer.prototype = L.CanvasLayer.extend({

      render: function() {
        var canvas = this.getCanvas();
      	var animator = new Animator(canvas);
        var ctx = canvas.getContext('2d');

        // clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // get center from the map (projected)
        var point = this._map.latLngToContainerPoint(new L.LatLng(0, 0));

        // render
        this.renderCircle(ctx, point, (1.0 + Math.sin(Date.now()*0.001))*300);
      },
      addLine: function(){

      }
    });

    var layer = new FluxLayer();
    layer.addTo(map);

	window.onload = function(){
		
		var line = new Line([{x: 20, y: 50}, {x: 150, y: 200}, {x: 400, y: 320}]);
		animator.addLine(line);
		animator.play();
	};
	
</script>
</html>